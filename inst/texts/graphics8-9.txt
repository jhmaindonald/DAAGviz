8
Graphics ­ Base, Lattice, Ggplot, . . .


 Base Graphics (mostly 2-D):
    Base graphics implements a "traditional" style of graphics
    Functions    plot(), points(), lines(), text(),                       The function plot() accepts a
                 mtext(), axis(),identify() etc. form                     data argument. The functions
                 a suite that plot points, lines, text, etc.              lines(), points() and text()
                                                                          do not.

Other Graphics
      (i) lattice (trellis) graphics, using the lattice package,          lattice and ggplot2 are built on the
      (ii) ggplot2, implementing Wilkinson's Grammar of Graphics          low-level graphics package grid.
      (iii) For 3-D graphics (Section 9.1), note rgl, misc3d & tkrplot
      (iv) Motion Charts (Section 9.2), show a scatterplot changing
      with movement forward or backward in time.
                                                                          Note also various special types of
                                                                          graph. For example word clouds,
    Consider first base graphics. Relative to lattice and to ggplot2,
                                                                          as provided in the wordcloud
the more traditional style of base graphics is less consistent and less   package, list words with size
structured. Each system however has its own strengths and uses.           proportional to frequency.
## DAAG has several datasets that will be required
l i b r a r y (DAAG, q u i e t l y =TRUE)


                                                                          To see a variety of base (or tradi-
8.1      Base Graphics                                                    tional) graphics plots, enter
                                                                          demo ( g r a p h i c s )
The function plot() is the most basic of several functions that
create an initial graph. Other functions can be used to add to an         Press Enter to see each new graph.
existing graph. Note in particular points() lines() and text().

                                                                          Plot height vs weight ­
8.1.1 plot() and allied base graphics functions
                                                                          ## Older syntax :
The following are alternative ways to plot y against x (obviously x       w i t h ( women ,
                                                                                    p l o t ( height , weight ) )
and y must be the same length):
plot (y  x)         # Use a formula to specify the graph                  ## Graphics formula :
plot (x , y)        # Horizontal ordinate , then vertical                 p l o t ( weight  height ,
                                                                                    d a t a =women )
98   data analysis, graphics, and visualisation using r

    The following use the argument data to supply the name of a
data frame whose column names appear in the graphics formula:
p l o t ( d i s t a n c e  s t r e t c h , data=e l a s t i c b a n d )
p l o t (ACT  y e a r , d a t a = a u s t p o p , t y p e =" l " )
p l o t (ACT  y e a r , d a t a = a u s t p o p , t y p e =" b " )

     The points() function adds points, while lines() adds lines1                      1
                                                                                        Actually these functions dier
to a plot. The text() function adds text at specified locations. The                   only in the default setting for
mtext() function places text in one of the margins. The axis()                         the parameter type. Explicitly
function gives fine control over axis ticks and labels.                                setting type = "p" causes either
                                                                                       function to plot points.
     Here is a further possibility
w i t h ( a u s t p o p , p l o t ( s p l i n e ( y e a r , ACT ) , t y p e =" l " )
   # Fit smooth curve through points




                                                                                                              1500
)
                                                                                                                               Human




                                                                                                              1000
                                                                                           Brain weight (g)
8.1.2      Adding points, lines and text ­ examples
Here is a simple example (Figure 8.1) that uses the function text()




                                                                                                              500
                                                                                                                               Chimp            Gorilla
to label the points on a plot.
                                                                                                                         Rhesus monkey
     Code for a simplified version of the plot is:
                                                                                                                     
                                                                                                                         Potar monkey




                                                                                                              0
p l o t ( B r a i n w t  Bodywt , x l i m=c ( 0 , 3 0 0 ) ,                                                          0    50    100       200             300
          y l i m=c ( 0 , 1 5 0 0 ) , d a t a = p r i m a t e s ,                                                              Body weight (kg)
          x l a b =" Body w e i g h t ( kg ) " ,
          y l a b =" B r a i n w e i g h t ( g ) " )                                   Figure 8.1: Plot of brain weight
# Specify xlim to allow room for the labels                                            against body weight, for selected
with ( primates ,                                                                      primates.
          t e x t ( B r a i n w t  Bodywt ,
                    l a b e l s =rownames ( p r i m a t e s ) , p o s = 4 ) )          ## Data (1 st 2 lines)
# pos: pos =1 (below), 2 (left), 3 ( above)                                            head ( p r i m a t e s , 2)

                                                                                                                                  Bodywt Brainwt
                                                                                       Potar monkey                                   10
8.1.3      Fine control ­ Parameter settings                                           115
                                                                                       Gorilla                                          207
In most (not all) instances, parameters can be set either using par(),                 406
or in a call to a plotting function (plot(), points(), . . . ). Changes
made using par() remain in place until changed again, or until a
new device is opened. If made in a call to a plotting function, the
change applies only to that call.
                                                                                        To store existing settings for later
     Some of the more common settings are:
                                                                                       restoration, proceed thus:
- Plotting symbols: pch (choice of symbol); cex ("character expan-                     oldpar     p a r ( c e x =1 . 2 5 )
  sion")2 ; col (color).                                                                 # par( oldpar ) to restore

- Lines: lty (line type); lwd (line width); col (color).                               2
                                                                                        Thus par(cex=1.2) increases
                                                                                       plot symbol size 20% above the
- Axis limits: xlim; ylim.                                                             default.
- Closeness of fit to the axis limits: xaxs, yaxs.3 Specify                            3
                                                                                         The default is xaxs="r"; x-axis
  xaxs="i" for an exact fit to the data limits.                                        limits are extended by 4% relative
                                                                                       to data or xlim limits.
                                                                              graphics ­ base, lattice, ggplot, . . .      99

- Axis annotation and labels: cex.axis (for axis annotation, inde-
  pendently of cex); cex.labels (for axis labels).
- Margins and positioning within margin:4 mar (inner margins                            4
                                                                                          Parameters such as mar, mgp and
  clockwise from bottom, out of box default mar=c(5.1, 4.1,                             oma specify distances in `lines' out
  4.1, 2.1)); oma (outer margins, use when there are multiple                           from the relevant boundary of the
  plots on the one graphics page); positioning within margin: mgp                       figure region. Lines are in units of
                                                                                        mex, where by default mex=1.
  (margin line for the axis title, axis labels, and axis line, default
  mgp=c(3, 1, 0)).
- Plot shape: pty="s" gives a square plot.5 (default is pty="m")                        5
                                                                                            This must be set using par()
- Multiple graphs on the one graphics page: par(mfrow=c(m,n))                           For a 1 by 2 layout of plots; spec-
  gives an m rows by n columns layout.                                                  ify par(mfrow=c(1,2)). Subsec-
                                                                                        tion 5.2.1 has an example.
Type help(par) to get a (very extensive) complete list. Figure 15.8
demonstrates some of the possibilities.

Color palettes
The function colors() gives access to 657 dierent color names,
some of them repeats of the same colour. The function palette()
can be used to show or set colors that will by default be used for
base graphics. Thus
- palette() displays the colors in the current palette;
- as an example, palette(rainbow(6)) sets the current palette to
  a 6-color rainbow palette;
- palette("default") resets back to the default.
    Run the following code to show the default palette, three se-                       See help(palette) for palettes
quential palettes from grDevices, a color ramp palette given by the                     in the base R grDevices package.
function colorRampPalette(), and two quantitative palettes from
the RColorBrewer package.
## Load to run code for Supplementary Figure 1
l i b r a r y ( R C o l o r B r e we r ) # Required for Set1 and Dark2 RColorBrewer palettes

colpal              rev ( l i s t (
        " Default palette " = palette ()[1:8] ,                          cm.colors = cm.colors (12) ,
        t e r r a i n . c o l o r s = t e r r a i n . c o l o r s (12) , heat.colors = heat.colors (12) ,
        blueRamp = c o l o r R a m p P a l e t t e ( c ( b l u e s 9 , " w h i t e " ) ) ( 1 2 ) ,
        " Brewer Set1 " = b r e w e r . p a l ( 8 , " Set1 " ) ,
        " Brewer Dark2 " = b r e w e r . p a l ( 8 , " Dark2 " ) ) )
palnam              names ( c o l p a l )
p l o t ( 1 , 1 , x l i m=c ( 0 . 5 , 1 2 . 5 ) , y l i m=c ( 0 , l e n g t h ( palnam )+0 . 5 ) , t y p e =" n " ,
          a x e s =FALSE , x l a b =" " , y l a b =" " )
f o r ( i i n 1 : l e n g t h ( palnam ) ) {
        t e x t ( 1 , i , palnam [ i ] , a d j =0)
        len           length ( colpal [[ i ]])
        p o i n t s ( 1 : l e n , r e p ( i 0 . 4 , l e n ) , pch =15 , c o l = c o l p a l [ [ i ] ] , c e x =3)
}
100                 data analysis, graphics, and visualisation using r

Each of these palettes, except the default, allows variation in the
number of colors, up to a maximum. The palettes available from
RColorBrewer include other qualitative palettes, sequential palettes,
and diverging (light in the middle; dark at the extremes) palettes. To
see the full range of RColorBrewer possibilities, type:                                                                                                                           Stretch the graphics window
                                                                                                                                                                                  vertically (pull on an edge) so that
display.brewer.all ()
                                                                                                                                                                                  rows do not overlap.
 Qualitative schemes that may be suited for use in plots are "Set1"                                                                                                               While limited use of light colors is
with yellow (the 6th color out of nine) omitted, or "Dark2", or "Ac-                                                                                                              fine for coloring regions on a map,
cent" with the 4th color (out of 8) omitted. To extract these, do for                                                                                                             light colors do not show up well
                                                                                                                                                                                  when coloring points on a graph.
example:
Set1            brewer.pal (8 , " Set1 " ) [ 6]
## Check out the palette
p l o t ( 1 : 7 , pch =16 , c e x =2 , c o l = S e t 1 )


8.1.4                            Graphs with many points

             A: 100% opacity                                                                                B: 40% opacity                           C: Color density plot        Figure 8.2: In Panel A, points are
                                                                                                                                            25000
    25000




                                                                                                   25000




             
              
               




                 
                      


                        
                          
                         




                           
                              
                             




                               
                                 
                                    

                                       
                                       
                                          




                                            
                                            


                                             
                                                
                                                  
                                                    



                                                      
                                                    
                                                      
                                                       
                                                        


                                                       

                                                         

                                                         
                                                         

                                                          
                                                          
                                                              
                                                              
                                                                        

                                                             

                                                             
                                                              



                                                               
                                                                
                                                                   
                                                                   

                                                                    
                                                                    
                                                                    
                                                                    
                                                                     
                                                                     
                                                                      
                                                                              
                                                                      
                                                                       
                                                                          
                                                                         
                                                                           


                                                                                
                                                                       
                                                                         
                                                                           
                                                                            
                                                                           
                                                                           
                                                                           
                                                                                    



                                                                              


                                                                                
                                                                              
                                                                               
                                                                               




                                                                               
                                                                                
                                                                                 
                                                                                  
                                                                                 
                                                                                   




                                                                                   
                                                                                    
                                                                                         

                                                                                      
                                                                                     
                                                                                      
                                                                                      
                                                                                       
                                                                                        

                                                                                          
                                                                                           
                                                                                           
                                                                                           
                                                                                           
                                                                                           
                                                                                           
                                                                                            

                                                                                            
                                                                                            




                                                                                            
                                                                                          
                                                                                            
                                                                                            
                                                                                            

                                                                                             
                                                                                             
                                                                                             
                                                                                             


                                                                                             
                                                                                             
                                                                                                                                                                                  plotted with the 100% opacity,
                                                                                                                                                                                  i.e., no transparency. In Panel
                                
                     
                                        
                                                   
                                                                                
                                                                                             
                                                                                             
                                                                                    
                                                                                             
                                                                                             
                                                     
                                                     
                                                         
                                                                                             
                                                                                    
                                                                                   
                                                                                            
              
                     
                                    
                                                                                       
                                                                                            
                                                  
                                                                                           
                                                                                             
                                                          
                                                                          
                                                                                             
                                                                 
                                                                             
                                                                                             
                                                        
                                                                                
                                                                                             
                                                                                             
                                                                
                                                                          
                                                                                             
                                                       
                                                                     
                                                                          
                                                                                             
                                                                                                                                           15000




                                                          
   15000




                                                                  
                                                                                                  15000




                                                                                             




                                                                                                                                                                                  B, alpha=0.4, i.e., 60% trans-
                                                                                       
                                                                                            
                                                              
                                                                                             
                                                                            
                                                                                      
             
                                                                        
                                                        
                                                                 
                                                                               
                                                                          
                                                             
                                                                                             
                     
                                                                                             
                                                              
                                                                                             
                                                   
                                                     
                                                         
                                                             
                                                                               
                              
                                                                                           
                                                                             
 re78




                                                                                                re78




                                                                                                                                         re75




                                                                                           
                                                             
                                                                                     
              
                                                                                      
                  
                                                                                            
                          
                                              
                                                                                      
                                                                                             
                                                       




                                                                                                                                                                                  parency. Panel C uses the function
                               
                       
                                         
                                                                                             
                                                             
                            
                                                                                             
                 
                                                                                             
                                                                                 
                                        
                                                                                     
                        
                                                                                      
                                                               
                                                                                            
                      
                                      
                                                                               
             
                          
                       
                                                                                        
                                                                                             
              
                 
                                                                                             
                                                                                             
                  
                                                             
                                                                     
                                      
                                                                          
                                                                                             
                                                        




                                                                                                                                                                                  smoothScatter() to show a
                                                              
                    
                                           
                                                       
                                                                                            
                                                            
               
                                                                                            
                                                                                                                                            0 5000




                                                                                   
    0 5000




                                                                                                   0 5000




                                                                                             
             
              
                    
                                                              
                                                                                             
                    
                              
                                
                                     
                                                 
                                                                            
                                                                        
                                           
               
                                  
                                                                            
                                     
                                                                           
                       
                        
                                                                              
                                                                                
             
                                                  
                                                                  
                                                                                             
                 
                                                                                           




                                                                                                                                                                                  smoothed color density representa-
                                                                                             
                  
                
                      
                           
                                                           
                                                                    
              
                     
                                    
                                                                                         
               
                     
                                     
                                                                                             
                                                          
                                                                                             
                                                                    
                                   
                                                                                
              
                                                                                             
                                      
                                                                      
                
               
                                                                                             
                                                       
               
                                                                                             
                                    
                         
                                             
                                                                           
                                                                              
                                                                                         
                                                                                             




             0          5000                     15000
                                               re75
                                                                                   25000                    0   5000     15000
                                                                                                                       re75
                                                                                                                                 25000               0   5000     15000
                                                                                                                                                                re74
                                                                                                                                                                          25000   tion of the data.

                                                                                                                                                                                  An opacity of 0.4 has the eect
                                                                                                                                                                                  that, for an isolated point, 60%
## Sample from the 15992 rows                                                                                                                                                     of the white background shows
dfsamp              c p s 1 [ s a m p l e ( nrow ( c p s 1 ) , 3 0 0 0 ) , ]                                                                                                      through. Two overlapping points
p l o t ( r e 7 8  r e 7 5 , d a t a =dfsamp , pch =20 , c e x =0 . 5 ,                                                                                                           have a combined opacity of 80%,
          c o l =" b l a c k " )                                                                                                                                                  so that 20% of the white back-
m t e x t ( s i d e =3 , l i n e =0 . 5 , "A: 100% o p a c i t y " , a d j =0)                                                                                                    ground shows through. Regions
p l o t ( r e 7 8  r e 7 5 , d a t a =dfsamp , pch =20 , c e x =0 . 5 ,                                                                                                           where 3 or more points overlap are
          c o l = a d j u s t c o l o r ( " b l a c k " , a l p h a =0 . 4 ) )                                                                                                    completely black.
m t e x t ( s i d e =3 , l i n e =0 . 5 , "B : 40% o p a c i t y " , a d j =0)
blackRamp                 colorRampPalette ( c ( " white " , " black " ) )
w i t h ( dfsamp , s m o o t h S c a t t e r ( r e 7 5 r e 7 4 ,
                                                      c o l r a m p=blackRamp ) )
m t e x t ( s i d e =3 , l i n e =0 . 5 , "C : C o l o r d e n s i t y p l o t " ,
            a d j =0)

    Compare three plots shown in Figure 8.2. Points overlap to such                                                                                                               Note that the plots show a sample
an extent that Panel A, gives very limited information about the                                                                                                                  of 3000 of the points. Plotting all
density of points. Panel B, where the color opacity is 40%, gives                                                                                                                 the points gives an incoveniently
                                                                                                                                                                                  large graphics file, while not
a better indication of variation in the density of points. Panel C
                                                                                                                                                                                  giving a more informative graph.
uses the function smoothScatter() to provide a color density
representation of the scatterplot.
                                                                                                     graphics ­ base, lattice, ggplot, . . .                     101

The shape of the graph sheet
Figures 8.3A and 8.3B show the same data:

          A: Aspect ratio approx 1:1                     B: Aspect ratio approx 1:3.5
          1.0




                                                        1.0
                                                                                                                                                           
                                                                                          
                                                                                                                 
                                                                                                                                       
                                                                                                                                                              
          0.5




                                                        0.5
                                                                                                                                 
                                                                                                           
                                                                                             
                                                                                                                    
          0.0




                                                        0.0
                                                                                                                                          
                                                                                                                                                   
                                                                                                                              
                                                                            
                                                                                                        
                                                                                                                        
                                                                                                                                             
          -1.0




                                                        -1.0
                                                                                                                                                


                 0      5   10 15 20 25                        0               5                10               15              20                25

                                                                                                                      Figure 8.3: Figures A and B show
                                                                                                                      the same data, but with widely
For each of Figures 8.3A and 8.3B the code, after setting the dimen-                                                  dierent aspect ratios.
sions of the figure page, is:
p l o t ( ( 1 : 3 0 ) *0 .92 , s i n ( ( 1 : 3 0 ) *0 . 9 2 ) ,                                                       Note that the shape and size of a
          x l a b =" " , y l a b =" " )                                                                               graph that is displayed on a screen
                                                                                                                      device can be changed by clicking
     There is provision to specify the size and shape of the graphics                                                 and dragging on one corner.
page. The R for Windows functions win.graph() or x11() that
set up the Windows screen take the parameters width (in inches),
height (in inches) and pointsize (in 1/72 of an inch). The setting
of pointsize (default =12) determines character heights. It is the
relative sizes that matter for screen display or for incorporation into
Word and similar programs.

8.1.5      Identification and Location on the Figure Region
Draw the graph first, then call the required function.                                                                Section 2.2 described how to
                                                                                                                      terminate the plot, if the limit n is
- identify(), discussed in Subsection 2.2, labels points.                                                             not reached first. For locator(),
- locator() prints out the co-ordinates of points. Position the                                                       n is by default set to 500.
  cursor at the location for which coordinates are required, and click
  the left mouse button.

8.1.6      Multiple plots on the one page
The parameter mfrow can be used to configure the graphics sheet                                                       For a layout in which columns are
so that subsequent plots appear row by row, one after the other in                                                    filled before moving to a new row,
a rectangular layout, on the one page. The following presents four                                                    use mfcol in place of mfrow.
dierent transformations of data from the dataset Animals (MASS),
in a two by two layout:
## Supplementary figure 8.2
l i b r a r y (MASS)
oldpar           p a r ( pch =16 , p t y =" s " , mfrow=c ( 2 , 2 ) )
102       data analysis, graphics, and visualisation using r

w i t h ( Animals , {                # bracket several R statements
    p l o t ( body , b r a i n )
    p l o t ( s q r t ( body ) , s q r t ( b r a i n ) )
    p l o t ( body ^ 0 . 1 , b r a i n ^ 0 . 1 )
    p l o t ( l o g ( body ) , l o g ( b r a i n ) )
})                                   # close both sets of brackets
par ( oldpar )                       # Restore former settings

    A more flexible alternative is to use the graphics parameter fig
to mark out the part of the graphics page on which the next graph
will appear. The following marks out, successively, a plot region that
occupies the upper 62% of the plot region, then the lower 38%.
par ( f i g = c ( 0 , 1 , 0 .38 , 1 ) )                                            par(fig = c(0,1,0.38,1))
                # xleft , xright , ybottom , ytop                                  marks out a plot region that is
## Panel A                                                                         the total width, starts 38% of
p a r ( f i g = c ( 0 , 1 , 0 , 0 . 3 8 ) , new=TRUE)                              the way up, and extends to the
## Plot graph B                                                                    top. par(fig=c(0,1,0,0.38),
par ( f i g = c (0 , 1 , 0 , 1))            # Restore settings                     new=TRUE) marks out the lower
                                                                                   38% of the page.
   The eect of new=TRUE is, somewhat counter-intuitively, "as-
sume a new page is already open; do not open a new page".

8.1.7             Plots that show the distribution of data values
                                                                                   Density plots are much preferable,
We discuss histograms, density plots, boxplots and normal probabil-                for most purposes, to histograms.
ity plots.                                                                         Both have limitations, as will be
                                                                                   noted.
Histograms and density plots
The shapes of histograms depend on the placement of the breaks, as
Figure 8.4 illustrates:


           A: Breaks at 72.5, 77.5,...                  B: Breaks at 75, 80, ...   Figure 8.4: The two panels show
                                                                                   the same data, but with a dierent
                                                                                   choice of breakpoints.
      0.04 0.08




                                            0.04 0.08
       Density




                                             Density
          0.00




                                                0.00




                   75   80 85 90       95               75   80     85 90 95
                        Total length                              Total length


      Here is code that plots the histograms and superimposes the                  The function rug() can be used to
density plots: The argument freq=FALSE ensures that the vertical                   add, to any of these plots, stubby
scale will be labeled according to number of points per unit interval,             vertical lines that show the loca-
                                                                                   tion of the data values.
i.e., according to the "density" estimate that is given by the upper
bar of each rectangle. This allows the subsequent superposition of a
density curves onto the histogram.
                                                                                 graphics ­ base, lattice, ggplot, . . .        103

ftotlen                s u b s e t ( possum , s e x==" f " ) [ , " t o t l n g t h " ]
## Left panel : breaks at 72.5 , 77.5 ,..
h i s t ( f t o t l e n , b r e a k s = 72 . 5 + ( 0 : 5 ) * 5 , f r e q =FALSE ,
          x l a b =" T o t a l l e n g t h " , y l i m=c ( 0 , 0 . 1 1 ) ,
          main ="A: B r e a k s a t 72 . 5 , 77 . 5 , . . . " )
## Now superimpose a density curve , as in Fig. 7.3
lines ( density ( ftotlen ))
##
## Panel B: breaks at 75, 80, ...
h i s t ( f t o t l e n , b r e a k s = 75 + ( 0 : 5 ) * 5 , f r e q =FALSE ,
          x l a b =" T o t a l l e n g t h " , y l i m=c ( 0 , 0 . 1 1 ) ,
          main="B : B r e a k s a t 7 5 , 8 0 , . . . " )
     The height of each rectangle of a histogram provides a crude                          Unless samples are very large,
density estimate. These estimates change in jumps, at breakpoints                          the shape of both histograms
that are inevitably chosen somewhat arbitrarily. A smoothly chang-                         and density plots will show large
                                                                                           statistical variability.
ing density estimate, such as given by the superimposed density
curve in the two panels of Figure 8.4, makes much better sense.                            Density plots are helpful for show-
     The following gives a density plot, separately from the his-                          ing the mode, i.e., the density
tograms that are shown in 8.4.                                                             maximum. Neither histograms
                                                                                           nor density plots are eective for
## Supplementary figure 8.3                                                                checking normality. For that, use a
w i t h ( s u b s e t ( possum , s e x==" f " ) ,                                          normal probability plot.
          p l o t ( d e n s i t y ( t o t l n g t h ) , t y p e =" l " ) )
    For use of density plots with data that have sharp lower and/or
upper cuto limits, it may be necessary to specify the x-axis limit or
                                                                                           6
                                                                                            For example, a failure time
limits.6 Use the parameters from and/or to for this purpose. This                          distribution will have a sharp
                                                                                           cuto at zero, which may also be
issue most commonly arises with a lower cuto at 0.                                         the mode.

Boxplots
Boxplots use a small number of characteristics of a distribution
to characterize it. Look up help(boxplot) for details. It can be
insightful to add a "rug" that shows the individual values, by default                         


along the horizontal axis (side=1). Figure 8.5 is an example. Code
for the plot is:
                                                                                               75   80    85     90        95
## Code
w i t h ( s u b s e t ( possum , s e x==" f " ) ,                                          Figure 8.5: Distribution of lengths
          { b o x p l o t ( t o t l n g t h , h o r i z o n t a l =TRUE)                   of female possums. The bars
            rug ( t o t l n g t h )} )                                                     (together making up a 'rug') show
                                                                                           actual data values.

Normal probability plots
                                                                                           A point pattern that is not con-
The function qqnorm(y) gives a normal probability plot of the                              sistent with random deviation
values of y. In such a plot, data from a normal distribution will be                       from a line indicates a non-normal
scattered about a line. To calibrate the eye to recognise plots that                       distribution.
indicate non-normal variation, it helps to compare the plot for the
data in hand with several normal probability plots that use rnorm()
to generate random values. Figure 8.6 is an example.
104                data analysis, graphics, and visualisation using r


                   Normal Q-Q Plot                             Q-Q: Simulated                              Q-Q: Simulated                                    Q-Q: Simulated




                                                    2
                                                                                                                                                                                  




                                                                                                                                                1.5
                                                                                                                                                                              
         95

                                                                                                                              
                                                                                                                              
                                                                                                                                                                         
                                                                          




                                                -1 0 1
                                                                                                                                                                         




                                                                                                    1
                                                                                                                                                                        
                                                                                                                       
                                                                                                                      
  85 90



                                                                                                                                                                        




                                               Simulated




                                                                                          Simulated




                                                                                                                                              Simulated
                                                                                                                                         -1.5 -0.5 0.5
                                                                                                                                                                        
                                                                                                                                                                       
  Data




                                                                                                                                                                      
                                                                                                                   




                                                                                              0
                                                                                                                                                                     
                                                                                                                                                                     
                                                                                                                                                                    
                                                                                                                                                                    
                                                                   
                                                                                                                                                                   
                                                                                                                
                                                                                                                                                                  
                                                                                                               




                                                                                         -1
                                                                                                                                                                 
                                                                                                               
         80




                                                                                                                                                                 
                                                                                                              
                                                                                                                                                              
                                                                                                                                                             
                                                                                                           
                                                                                                                                                             
         75




                                                    -3




                                                                                               -2
                                                                                                                                                          

                   -2     -1   0   1    2                   -2       -1   0   1   2                     -2       -1   0   1      2                        -2     -1   0   1   2



                      Q-Q: Simulated                           Q-Q: Simulated                              Q-Q: Simulated                                    Q-Q: Simulated
                                                                                                                                                                                  
                                                                                                                                                                            




                                                                                                                                                2
                                                                                                                        
         2




                                                                                                                                                                            
                                                  0.0 1.0


                                                                           




                                                                                                   1
                                                                                                                      
                                                                                                                                                                           
                                 
                                                                         
                                                                                                                                                                           
       Simulated




                                               Simulated




                                                                                         Simulated




                                                                                                                                             Simulated
                                                                                                                                                                         




                                                                                                                                                     1
                               
              1




                                                                                                                                                                         
                                                                                                                                                                        
                                                                                                                                                                        




                                                                                         -1 0
                                                                                                                                                                       
                                                                                                                  
                                                                                                                 
                                                                     
                                                                                                                                                                      
                                                                                                                                                                       




                                                                                                                                         -2 -1 0
                                                                                                                                                                      
  -2 -1 0




                                                                                                                                                                      
                                                                                                                
                                                                                                                                                                     
                                                                                                                                                                     
                                                                                                                                                                     
                         
                                                                                                                                                                    
                                                                                                                                                                    
                                                                                                                                                                   
                                                                                                                                                                  
                                                                                                                                                                 
                       
                                                    -1.5




                                                                                                                                                                




                                                                                               -2
                                                                                                                                                                
                                                                                                                                                             
                                                                                                                                                          

                   -2     -1   0   1    2                   -2       -1   0   1   2                     -2       -1   0   1      2                        -2     -1   0   1   2

                                                                                                                                 Figure 8.6: Normal probability
## Q-Q plot for the data (top left panel)                                                                                        plots. The top left panel shows
ftotlen           s u b s e t ( possum , s e x == " f " ) [ , " t o t l n g t h " ]                                              the 43 lengths of female possums.
qqnorm ( f t o t l e n , x l a b =" " ,                                                                                          Other panels are for independent
         y l a b= e x p r e s s i o n ( bold ( " Data " ) ) )                                                                    normal random samples of size 43.
## Code for a plot with random normal data
qqnorm ( rnorm ( 4 3 ) , x l a b =" " , y l a b =" S i m u l a t e d " )

There is one unusually small value. Otherwise the points for the
female possum lengths are as close to a straight line as in many of
the plots for random normal data.


8.1.8                     Plotting     Text that Includes Technical Symbols
The functions expression() and substitute() can be used to create                                                                Axis labels can be expressions, in
mathematical expressions, for later evaluation or for printing onto a                                                            lattice and ggplot2 as well as in
graph. For example, expression(x^2) will print, when supplied to                                                                 base graphics. Tick labels can for
text() or mtext() or another such function (this includes lattice                                                                example be vectors of expressions.
and ggplot2 functions), as x2 .
    For purposes of adding text that includes mathematical and other
technical symbols, the notion of expression is generalized, to allow
"expressions" that it does not make sense to try to evaluate. For
                                                                                                                                 Items that are separated by an
example, expression("Temperature (" * degree * "C)")                                                                             asterisk (*) are juxtaposed side by
prints as: Temperature ( C).                                                                                                     side. The initial text is followed by
    The following indicate some of the possibilities:                                                                            a degree symbol, and then by the
                                                                                                                                 final text.
- Letters such as a, b, c, x, . . . are printed literally.
- alpha denotes the Greek letter , while Alpha denotes the upper
  case symbol. Similarly for other Greek letters.
                 ^
- hat(x) denotes x.
                                                                                     graphics ­ base, lattice, ggplot, . . .                            105

- italic(x), bold(x), bolditalic(x), and plain(x) have the




                                                                                                                80
  obvious meaning.                                                                                                                                      


- frac(a,b) denotes a .




                                                                                                                60
                    b




                                                                                                 Area = r 2
                                                                                                                                                 
    Figure 8.7 demonstrates the use of an expression to provide




                                                                                                                40
y-axis labeling. The code is:                                                                                                          




                                                                                                                20
yl          e x p r e s s i o n ( " Area = " * p i *         r ^ 2 )                                                        
p l o t ( 1 : 5 , p i * ( 1 : 5 ) ^ 2 , x l a b =" R a d i u s ( r ) " , y l a b = y l )                             


The tilde (~) in r^~2 is used to insert a small space.                                                               1      2          3         4      5

     Use substitute() in place of expression() when symbols                                                                     Radius (r)
in the expression are to be replaced by values that will be provided at                        Figure 8.7: A mathematical ex-
the time of forming the expression.                                                            pression is included as part of the
     See help(plotmath) for further details of the conventions, and                            y-axis label..
of the symbols that are available. Type demo(plotmath) to see a
wide range of examples of what is possible.


8.2      Lattice Graphics
Lattice Graphics:                                                                              The lattice package is included
                                                                                               in all R binary distributions that
  Lattice       Lattice is a flavour of trellis graphics
                                                                                               are available from a CRAN (Com-
                (the S-PLUS flavour was the original)                                          prehensive R Archive Network)
  Lattice       Lattice is more structured, automated and stylized.                            mirror. It implements a trellis style
                                                                                               of graphics, as in the S-PLUS im-
  vs base       For standard purposes, much is automatic.
                                                                                               plementation of the S language.
  Lattice       Lattice syntax is consistent and tightly regulated                             It is built on the grid low-level
  syntax        For lattice, graphics formulae are mandatory.                                  graphics system, described in Part
                                                                                               II of Paul Murrell's R Graphics

     Lattice (trellis) graphics functions allow the use of the layout                           To see some of the possibilities
on the page to reflect meaningful aspects of data structure. Groups                            that lattice graphics oers, enter
can be readily distinguished within data, either using dierent colors                          demo ( l a t t i c e )
and/or symbols and/or line types within panels or using dierent
panels. Multiple columns of data can be plotted, either distinguished
within panels or using dierent panels.
     Later in this section, latticeExtra will be required, in addition to                                                   

lattice. Loading latticeExtra will at the same time load lattice, which                                       1200

latticeExtra has as a dependency.                                                                             1000
                                                                                                Brainwt




                                                                                                               800
l i b r a r y ( l a t t i c e E x t r a , q u i e t l y =TRUE)                                                 600
                                                                                                                         
                                                                                                               400                                   


                                                                                                               200   
                                                                                                                     

8.2.1      Lattice graphics ­ basic ideas                                                                            0   50      100       150   200

Figure 8.8 was obtained using the lattice function xyplot(). Super-                                                             Bodywt

ficially, this looks very like the way that the base graphics function                         Figure 8.8: Use of lattice function
plot() achieves the same end. Code is:                                                         xyplot() to give a graph.
106    data analysis, graphics, and visualisation using r

## On the command line: Create and print object
x y p l o t ( B r a i n w t  Bodywt , d a t a = p r i m a t e s )

     Note an important dierence between lattice and base graphics.
Lattice graphics functions do not print graphs.7 Instead they return             7
                                                                                  This applies also to ggplot2
trellis graphics objects. The graph appears when the object is printed           functions.
(use print() or plot()). Sending the output from a lattice graph-
ics function to the command line invokes print() and the graph is
plotted, as was done for Figure 8.8.
     A Brainwt versus Bodywt scatterplot for the primates data,
such as was given earlier, might alternatively have been obtained
using the function the function xyplot() from the lattice package.
## Save the result as a trellis graphics object
# [For plot (), this is not possible. ]
## Create trellis object
gph          x y p l o t ( B r a i n w t  Bodywt , d a t a = p r i m a t e s )
## Print graph; a graphics device must now be open
p r i n t ( gph )

    The object gph need not be printed at this point. It can be kept
for printing at some later time. Or it can be updated, using the func-
tion update(), and then printed, thus:
gph          x y p l o t ( B r a i n w t  Bodywt , d a t a = p r i m a t e s )
gph2           u p d a t e ( gph , x l a b =" Body wt ( kg ) " ,
                             y l a b =" B r a i n wt ( g ) " )
p r i n t ( gph2 ) # Or it is enough to type ' gph2 '

    Inside a function or in a file that is sourced, print() must ordi-           The graph will however be printed
narily be used to give a graph, thus:                                            if xyplot(...) is the final state-
                                                                                 ment in a function that returns its
p r i n t ( x y p l o t (ACT  y e a r , d a t a = a u s t p o p ) )              result to the command line.
    Mechanisms for the control of a wide variety of stylistic features
are best discussed in the context of multi-panel graphs, which we
now consider.

8.2.2     Panels of scatterplots
Graphics functions in the lattice package, are designed to allow
row by column layouts of panels. Dierent panels are for dierent
subsets of the data. Additionally, points can be distinguished, within
panels, according to some further grouping within the data.
    The ais dataset (DAAG) has data on elite Australian athletes
who trained at the Australian Institute of Sport. Data were collected
with a view to studying possible dierences in blood characteristics,
between athletes in endurance-related events and those in power-
related events. The help page for ais has details of the measure-
ments, including a variety of blood cell counts.
    A breakdown of the total of 202 athletes by sex and sport gives:
                                                                                           graphics ­ base, lattice, ggplot, . . .   107

w i t h ( a i s , t a b l e ( sex , s p o r t ) )
    sport
sex B_Ball Field Gym Netball Row Swim T_400m T_Sprnt Tennis W_Polo
  f       13   7   4      23 22     9     11       4      7      0
  m       12  12   0       0 15    13     18      11      4     17

     Figure 8.9 demonstrates the use of xyplot(), for the rower
and swimmer subset os the ais dataset. The two panels distinguish
the two sports, while dierent plotting symbols (on a color device,
dierent colors will be used) distinguish females from males.

                                                                                                     Figure 8.9: Height (ht) versus
                                                  50   60      70      80      90                    Weight (wt), for rowers (Row)
                        Row                                    Swim                                  and swimmers (Swim). Dier-
                                                                                                     ent plotting symbols are used to
                                   
                                    
                                    
                                                                             
                                                                            
                                                                                    
                                                                                                     distinguish males from females.
     190                             
                                    
                                                                                
                                   
                                                                            
     180
                                   
                                                                                       f
                                                                                       m
ht




                                                                                            

                                                            
     170
                

     160


           50      60   70    80      90

                                                 wt


Suitable code is:                                                                                    The setting
                                                                                                     auto.key=list(columns=2)
x y p l o t ( h t  wt | s p o r t , g r o u p s =sex , d a t a = a i s ,
                                                                                                     generates a simple key, with the
              p a r . s e t t i n g s =simpleTheme ( pch=c ( 4 , 1 ) ) ,
                                                                                                     items side by side in two columns
              s c a l e s = l i s t ( t c k =0 . 5 ) ,
                                                                                                     rather than stacked in a single col-
              a u t o . k e y = l i s t ( s p a c e =" r i g h t " ) ,
                                                                                                     umn as happens with the default
              s u b s e t = s p o r t%i n%c ( "Row" , " Swim " ) )
                                                                                                     columns=1.
    In the graphics formula ht ~ wt | sport, the vertical bar
indicates that what follows, in this case sport, is a conditioning
variable or factor. The graphical information is broken down by
levels of the factor sport. The parameter aspect controls the ratio
of dimensions in the y and x directions.
    The use of the argument par.settings, with its call to
simpleTheme requires explanation. This will now be given.

8.2.3      Setting stylistic features
The function simpleTheme() creates a "theme", i.e., a list of set-
tings, that can be supplied via the argument par.settings in the
graphics function call. Use of the argument par.settings makes
the settings locally, for the specific graphics object that results.
    The function simpleTheme() accepts arguments col, alpha,                                         An opacity value alpha that is
cex, pch, lty, lwd, font, fill, border. Note also col.points,                                        less than 1 can be helpful when
                                                                                                     there is extensive over-plotting.
108    data analysis, graphics, and visualisation using r

col.line, alpha.points and alpha.line. These allow separate
control (of color and of opacity) for points and lines.
    The function trellis.device() opens a new graphics device,           Settings made by
with settings that have in mind the use of lattice functions. The        trellis.device() or
                                                                         trellis.par.set() are global
function trellis.par.set() sets or changes stylistic features for        in their eect, but are over-written
the current device. Both these functions accept an argument theme.       by local settings that are stored as
Simple variations on the default theme can be created by a call to       part of the graphics object
simpleTheme().
    Subsection 8.2.6 has a detailed example.

Selected lattice functions
dotplot(factor ~ numeric,..)   # 1-dim. Display
stripplot(factor ~ numeric,..) # 1-dim. Display
barchart(character ~ numeric,..)
histogram( ~ numeric,..)
densityplot( ~ numeric,..)     # Density plot
bwplot(factor ~ numeric,..)    # Box and whisker plot
qqmath(factor ~ numeric,..)    # normal probability plot
splom( ~ dataframe,..)         # Scatterplot matrix
parallel( ~ dataframe,..)      # Parallel coordinate plot
cloud(numeric ~ numeric * numeric, ...)     # 3D surface
wireframe(numeric ~ numeric * numeric, ...)
# 3D scatterplot

In each instance, users can add conditioning variables.
     Do not try to use base graphics functions ­ points(), lines(),
text(), etc. ­ to add features to a plot that has been created using
a lattice function. Instead, use panel.points(), panel.text(),
and other such functions, as will be described in Subsection 8.2.9.

8.2.4     Groups within data, and/or columns in parallel
Table 8.1 shows selected rows from the data set grog (DAAG pack-
age). There are three liquor products (drinks), in dierent columns,
and two countries, occupying dierent rows that are indexed by the
factor Country.
    Figure 8.10 is one of several possible displays that might be used
to summarize the information in Table 8.1. It has been created by
updating the following simplified code:
## Simple version of plot
grogplot    xyplot (
              B e e r+ S p i r i t +Wine  Year | C o u n t r y ,
              d a t a =grog , o u t e r =FALSE ,
              a u t o . k e y = l i s t ( s p a c e =" r i g h t " ) )
      Observe that:
                                                                                                           graphics ­ base, lattice, ggplot, . . .   109


                                              Beer       Wine       Spirit    Country           Year                 Table 8.1: The data (dataset grog,
                                        1     5.24       2.86        1.81     Australia         1998                 from DAAG) are 1998 ­ 2006 Aus-
                                        2     5.15       2.87        1.77     Australia         1999                 tralian and New Zealand apparent
                                                                                                                     per person annual consumption (in
                                     ....
                                                                                                                     liters) of the pure alcohol content.
                                        9       4.57        3.11       2.15   Australia         2006                 Data, based on Australian Bureau
                                       10       4.50        2.59       1.77   NewZealand        1998                 of Statistics and Statistics New
                                       11       4.28        2.65       1.64   NewZealand        1999                 Zealand figures, are obtained by
                                     ....                                                                            dividing estimates of total avail-
                                       18       3.96        3.09       2.20   NewZealand        2006                 able alcohol by number of persons
                                                                                                                     aged 15 or more.

                                                                                                                     Figure 8.10: Australian and New
                                                                   1998 2000 2002 2004 2006                          Zealand apparent per person
Amount consumed (per person)




                                             Australia                     NewZealand
                                                                                                                     annual consumption (in liters)
                                             
                                                                                                                     of the pure alcohol content of
                               5                    
                                                                    
                                                                                       
                                                                                                                     liquor products, for 1998 to 2006.
                                                                                          
                               4                                                             
                                                                                                  Beer               Appendix 15 (Figure 15.1) has a
                               3                                                                  Spirit             color version of this graph.
                                                                                                  Wine
                               2

                               1


                                   1998 2000 2002 2004 2006




- Use of Beer+Spirit+Wine gives plots for each of Beer, Spirit
  and Wine. The eect of outer=FALSE is that these appear in the
  same panel.
- Conditioning by country (| Country) gives separate panels for
  separate countries.

                               The following updates the object to give Figure 8.10:
                                                                                                                     Notice the use of the func-
## Update trellis object , then print
                                                                                                                     tion simpleTheme() to set up a
ylab      " Amount consumed ( p e r p e r s o n ) "
                                                                                                                     "theme" that was used to control
parset       simpleTheme ( pch=c ( 1 , 3 , 4 ) )
                                                                                                                     point and line settings.
finalplot       u p d a t e ( g r o g p l o t , y l i m=c ( 0 , 5 . 5 ) ,
                                x l a b =" " , y l a b =y l a b ,
                                pa r.s ett ing s=parset )
print ( finalplot )

    Figure 8.10 used dierent symbols, in the one panel, to distin-
guish drinks. Dierent panels had then to be used to distinguish
countries . For separate panels for the three liquor products (dif-
ferent levels of Country can then use the same panel), specify
outer=TRUE:
x y p l o t ( B e e r+ S p i r i t +Wine  Year ,
              g r o u p s =C o u n t r y , o u t e r =TRUE ,
              d a t a =grog , a u t o . k e y = l i s t ( c o l u m n s =2) )
110    data analysis, graphics, and visualisation using r

    Where plots are superposed in the one panel and, e.g., regression
lines or smooth curves are fitted, this is done separately for each
dierent set of points. Dierent colors, and/or by dierent symbols
and/or line styles, can be used to make the necessary distinctions.
    Here is a summary:
 Break data down a/c to levels of the factor Country:
          Overplot (a single panel):                             Separate panels:
      Beer  Year, groups=Country                             Beer  Year | Country

 Plot columns in parallel, as in Beer+Wine+Spirit  Year:
            Overplot (a single panel):                              Separate panels:
                outer=FALSE                                          outer=TRUE

8.2.5      Keys ­ auto.key, key and legend
The argument auto.key=TRUE gives a basic key. If not otherwise                                 The argument auto.key sets
specified, colors, plotting symbols, and line type use the current                             up a call key=simpleKey().
settings for the device. The argument text has levels(groups) as                               If necessary, use legend=NULL
                                                                                               when updating, to remove an
its default. that identifies colors, plotting symbols and names for the
                                                                                               existing key and allow the addition
groups. For greater flexibility, auto.key can be a list. Settings that                         of a new key.
are often useful are:

- points, lines: in each case set to TRUE or FALSE.
- columns: number of columns of keys.
- x and y, which are coordinates with respect to the whole display
  area. Use these with corner, which is one of c(0,0) (bottom left
  corner of legend), c(1,0), c(1,1) and c(0,1).
- space: one of "top", "bottom", "left", "right".

 Use    of textGrob() to add legends
                                                                                                    Stripplot of cuckoo data

                                                                                                           wren         
                                                                                                                        
The function textGrob() (grid) creates a text object which can                                         tree.pipit         
                                                                                                                         


then be supplied to the lattice function. This mechanism for supply-                                       robin          
                                                                                                                         

                                                                                                    pied.wagtail            
                                                                                                                                   

ing legends can be used when multiple legends are required.                                        meadow.pipit
                                                                                                  hedge.sparrow
                                                                                                                        
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                          
                                                                                                                          
                                                                                                                              
                                                                                                                              
                                                                                                                                   

    The following code adds an initial legend, as in Figure 8.11:                                                   20 21 22 23 24 25

library ( grid )
plotnam               " S t r i p p l o t of cuckoo d a t a "                                  Figure 8.11: The argument
s t r i p p l o t ( s p e c i e s  l e n g t h , x l a b =" " , d a t a =c u c k o o s ,       legend has been used to add
    l e g e n d = l i s t ( t o p = l i s t ( f u n= t e x t G r o b ,                         text, supplied as a 'grob'.
                                              a r g s = l i s t ( l a b e l =p l o t n a m ,
                                                                  x =0))))
# x=0 is equivalent to x=unit (0," npc ")
# npc units are on a scale from 0 to 1

In this instance, the same result can be achieved, more straightfor-
wardly, using the argument main.
                                                                                                                                              graphics ­ base, lattice, ggplot, . . .                                              111

     Additional legends are supplied by adding further list elements,
for example a list element bottom as well as a list element top.

8.2.6                   Lattice settings ­ further notes
In general, use themes to make point, line and fill color settings. Use
the scales argument, in the call to the lattice function, for axes, tick                                                                                        For a visual display that shows
marks, and tick labels.                                                                                                                                         default settings for points, lines
    For changes that go beyond what simpleTheme() allows, first                                                                                                 and fill color, enter:
identify the names under which settings are stored. Type:                                                                                                       t r e l l i s . d e v i c e ( c o l o r =FALSE )
                                                                                                                                                                show.settings ()
> names(trellis.par.get())                                                                                                                                      t r e l l i s . d e v i c e ( c o l o r =TRUE)
                                                                                                                                                                show.settings ()
[1] "fontsize"         "background"                                                                                   "clip"
. . .
[28] "par.sub.text"

   The following sets the fontsize. Notice the separate settings for
text and points:

t r e l l i s . p a r . s e t ( l i s t ( fontsize = l i s t ( text = 7 , points = 4)))


Parameters that aect axes, tick marks, and axis labels
These are manipulated by use of the scales argument to the lattice
function. The code for Figure 8.12 provides an example.


                                                                                                Jan95      Jul95      Jan96       Jul96             Jan97

                                                 Alberta                                                           Prairies                                                                 Atlantic
                                                                                        1012
                                                                                  
                     1422                                                              (6.92)                                                                 973
                                                                               
                    (7.26)                                            
                                                                                         992                                                                (6.88)                                
                                                                                                                                                 
                                                                                                                                                                                            
                     1394                                                               (6.9)                                     
                                                                                                                                                              953            
                                                                                                                                                                                                     
                                                                                                                                                                                                              
                                                                                                                                                            (6.86)                                      
                    (7.24)                                                               973                                                                                                                           
  Number of jobs




                                                                                                                                                                                                                                
                     1366                  
                                              
                                                                                       (6.88)                                                                 934
                                        
                                                                                                                                                            (6.84)
                    (7.22)

                                                 Ontario                                                           Quebec                                    1845                              BC
                     5432                                                               3294                                                                                                                                    
                                                                                                                                                            (7.52)
                     (8.6)                                                              (8.1)                                                                                                                                
                                                                                                                                                             1808                                                         
                     5324                                                                                                   
                                                                                        3229                                                                 (7.5)                                                  
                                                                                                                                                                                                                       
                    (8.58)                                                             (8.08)                      
                                                                                                                                                                                                     
                                                                                                                                                                                                           
                                                                                                                                           
                                                                                                                                                             1772
                                                                                                                                                                                         
                     5219                                                               3165
                                                                                                                                                            (7.48)           
                                                                                                                                                                                   
                                                                                                                                                                                                  
                    (8.56)                                                             (8.06)                                                                                                  
                                                                                                                                                             1737
                     5115                                                                                                                                                 
                                                                                                                                                            (7.46)
                    (8.54)
                             Jan95      Jul95       Jan96          Jul96       Jan97                                                                                 Jan95      Jul95          Jan96          Jul96          Jan97



                                                                                                                                                                Figure 8.12: Jobs growth in Cana-
                                                                                                                                                                dian provinces, between January
                                                                                                                                                                1995 and December 1996.
                   The following gives a basic graph, which will then be updated:
## 1. Create a basic version of the graphics object
jobsB.xyplot
112      data analysis, graphics, and visualisation using r

    x y p l o t ( O n t a r i o +Quebec+BC+ A l b e r t a + P r a i r i e s + A t l a n t i c  Date ,
                  d a t a = j o b s , t y p e =" b " , l a y o u t =c ( 3 , 2 ) , o u t e r =TRUE ,
                  y l a b =" Number o f j o b s " ,
                  s c a l e s = l i s t ( y= l i s t ( r e l a t i o n =" s l i c e d " , l o g =TRUE ) ) )
Now make several enhancements:
- Change the y-axis labels to show number of jobs, with
  log(number) in parentheses underneath.
- Use dates of the form Jan95 to label the x-axis.8                                                         8
                                                                                                                Refer back to Subsection 6.4.7.
- Reduce tick marks in length (tck=0.6, i.e., 60% of the default).
- The argument between=list(x=0.5, y=0.5) adds horizontal
  and vertical space between the panels.9                                                                   9
                                                                                                             This prevents overlap between
                                                                                                            the tick labels.
## 2. Code for the enhancements to jobsB.xyplot
ylabpos               exp ( p r e t t y ( l o g ( u n l i s t ( j o b s [ , 7 ] ) ) , 1 0 0 ) )
ylabels               p a s t e 0 ( round ( ylabpos ) , " \ n ( " , log ( ylabpos ) , " ) " )
## Create a date object ' startofmonth ' ; use instead of ' Date '
atdates               s e q ( from =95 , by=0 . 5 , l e n g t h =5)
datelabs                f o r m a t ( s e q ( from= a s . D a t e ( " 1 J a n 1 9 9 5 " , f o r m a t ="%d%b%Y" ) ,
                                              by=" 6 month " , l e n g t h = 5 ) , "%b%y " )
u p d a t e ( j o b s B . x y p l o t , x l a b =" " , b e t w e e n= l i s t ( x=0 . 5 , y=0 . 5 ) ,
              s c a l e s = l i s t ( x= l i s t ( a t = a t d a t e s , l a b e l s = d a t e l a b s ) ,
                                      y= l i s t ( a t = y l a b p o s , l a b e l s = y l a b e l s ) , t c k =0 . 6 ) )


8.2.7         Lattice plots that show distributions
Stripplots, dotplots and boxplots
Dierences between dotplot() and stripplot() are mainly
cosmetic. The function boxplot() presenst the same information in
a more summary form, and has a similar syntax. Because the syntax
for stripplot() and boxplot() are very similar, we demonstrate
suitable code side by side. Figure 8.13 summarizes information in
the cuckoos data (from DAAG):

                                                                                                            Figure 8.13: A stripplot and a
               wren          
                                                                wren           
                                                                                                            dotplot appear side by side.
           tree.pipit                                       tree.pipit                         
               robin                   
                                                                robin                    
        pied.wagtail                   
                                                         pied.wagtail                       
       meadow.pipit                     
                                                        meadow.pipit                               

      hedge.sparrow                       
                                                       hedge.sparrow                        

                         20   21   22   23   24   25                      20   21   22      23    24   25
                                                                                                            For slightly improved labeling,
                        Cuckoo egg length (mm)                           Cuckoo egg length (mm)             precede the code with:
                                                                                                            l e v e l s ( cuckoos $ s p e c i e s )
                                                                                                              sub ( " . " , " " ,
s t r i p p l o t ( s p e c i e s  l e n g t h , d a t a =c u c k o o s ,                                       l e v e l s ( cuckoos $ s p e c i e s ) ,
                    x l a b =" Cuckoo egg l e n g t h (mm) " )                                                  f i x e d =TRUE)
b w p l o t ( s p e c i e s  l e n g t h , d a t a =c u c k o o s ,
              x l a b =" Cuckoo egg l e n g t h (mm) " )
                                                                                     graphics ­ base, lattice, ggplot, . . .    113

    The aspect argument determines the ratio of distance in the
y-direction to distance in the x-direction.


8.2.8            Lattice style density plots
Here is a density plot (Figure 8.14), for data from the possum data
set (DAAG), that compares sexes and Vic/other populations.

                                                                                               Figure 8.14: Lattice style density
                                            40    45   50   55                                 plot comparing possum earconch
                             f                         m
                                                                                               measurements, separately for
                                                                                               males and females, between Vic-
          0.25
                                                                                               torian and other populations. Ob-
          0.20
                                                                                               serve that the scatter of data values
Density




          0.15
                                                                      Vic
                                                                      other                    is shown along the horizontal axis.
          0.10
          0.05
          0.00       
                         
                                                      
                                                       
                                                     
                                                    
                                                       


                   40   45       50   55

                                       earconch


## Code
colset              c ( " gray " , " black " )
d e n s i t y p l o t (  e a r c o n c h | sex , g r o u p s =Pop ,
                        d a t a =possum ,
                        p a r . s e t t i n g s =simpleTheme ( c o l = c o l s e t ) ,
                        a u t o . k e y = l i s t ( s p a c e =" r i g h t " ) )

    The functions densityplot() and histogram() do not allow
a name on the left of the  symbol. The function histogram(),
which is otherwise similar to densityplot(), does not accept a
groups argument.


8.2.9            Panel functions
Each lattice command that creates a graph has its own panel func-                              Subsection 8.2.10 will describe
tion. Creation of one's own panel function allows detailed control                             a radical extension of this basic
of panel contents. Or the panel function can be modified using the                             scheme. Further layers, created us-
update() function.                                                                             ing layer() and allied functions
                                                                                               in the latticeExtra package can be
    A user panel function will typically include, or consist of,                               "added" (the operator is "+") to a
calls to several of the variety of panel functions that are pro-                               trellis graphics object.
vided in lattice. The function xyplot() has the panel function
panel.xyplot().10 The following are equivalent:                                                10
                                                                                                 When a groups ar-
                                                                                               gument is supplied,
x y p l o t ( s p e c i e s  l e n g t h , x l a b =" " , d a t a =c u c k o o s )
                                                                                               panel.xyplot() calls the func-
x y p l o t ( s p e c i e s  l e n g t h , x l a b =" " , d a t a =c u c k o o s ,
                                                                                               tion panel.superpose().
              panel=p a n e l . x y p l o t )
114    data analysis, graphics, and visualisation using r

A user function, used in place of panel.xyplot(), might for ex-
ample call panel.superpose(), followed or preceded by other
available panel functions.
    Available panel functions include:
· panel.points(), panel.lines(), panel.text(),                                            Note that an alternative to
     panel.rect(), panel.arrows(), panel.segments(),                                      panel.points() is lpoints().
     panel.polygon()                                                                      Similarly for the other functions.
     (all documented on the same help page as panel.points());
· panel.abline(), panel.curve(), panel.rug(),
     panel.fill(), panel.average(),
     panel.mathdensity(), panel.refline(),
     panel.loess(), panel.lmline()
     (all documented on the same help page as panel.abline()).

    The following graphics object gph will be used as a starting
point, in the discussion that now follows:
gph         x y p l o t ( B r a i n w t  Bodywt ,          data=primates ,
                          x l i m=c ( 0 , 3 0 0 ) )

    Now create a panel function that both plots the points and adds
labels. The graphics object can then be updated, as in the code that
now follows, to use this panel function:
                                                                                                                   Human
                                                                                                    1200
my.panel                function (x , y ){
                                                                                                    1000
    panel.xyplot (x , y)
                                                                                          Brainwt

                                                                                                     800
    p a n e l . t e x t ( x , y , l a b e l s =rownames ( p r i m a t e s ) , p o s =4)
}                                                                                                    600
                                                                                                                  Chimp         Gorilla
u p d a t e ( gph , p a n e l = m y . p a n e l )                                                    400                     


                                                                                                     200      Rhesus monkey
                                                                                                              Potar monkey
    Note that we could have supplied a panel function that plots the
                                                                                                               50 100 150 200 250
points and adds the labels in the initial function call, thus:                                                      Bodywt
x y p l o t ( B r a i n w t  Bodywt , d a t a = p r i m a t e s ,
              x l i m=c ( 0 , 3 0 0 ) , p a n e l = m y . p a n e l )
                                                                                          Figure 8.15: Here, labels have
     A further possibility is to add a new layer that has the labels,                     been added to the points. This can
as in Subsection 8.2.10 which now follows. However the plot is                            be done by updating a graph that
obtained, Figure 8.15 shows the result.                                                   has the points, by use of a panel
                                                                                          function that both plots points and
                                                                                          and adds labels, or by adding a
8.2.10 The addition of new layers                                                         new layer to a graph that shows
                                                                                          the points.
The layering mechanism greatly extends the range of possibilities.
The code that follows gives a simple and somewhat trivial example
of its use ­ an alternative the use of a panel function for adding
labeling to Figure 8.15.
     Note again the graphics object gph, created above:
gph         x y p l o t ( B r a i n w t  Bodywt ,          data=primates ,
                          x l i m=c ( 0 , 3 0 0 ) )
                                                                                      graphics ­ base, lattice, ggplot, . . .             115

    The following uses the function layer(), from the latticeExtra
package, to create a second layer that has the labels. The layer that is
thus created is added to the graphics object gph:

library ( latticeExtra )
gph + l a t t i c e E x t r a : : l a y e r ( p a n e l . t e x t ( x , y ,
                                        l a b e l s =rownames ( p r i m a t e s ) ,
                                        pos =4))

Note also layer_(), which reverses the order of the layers, equiva-
lent to using layer() with under=TRUE.                                                          Other convenience functions are
     The function layer() allows as arguments, passed via the ...                               glayer() and glayer_(). These
argument, any sequence of statements that might appear in a panel                               are equivalent, respectively, to
                                                                                                calling layer() and layer_()
function. Such statements can refer to panel function arguments,
                                                                                                with superpose=TRUE. The layer
including 'x', 'y' and 'subscripts'. Additionally, named column                                 is drawn once for each level of any
objects can be passed through an optional data argument.                                        group in the plot.
     The function as.layer() creates a layer from a trellis graphics
object. This can then be "added" in the usual way.
                                                                                                For using playwith, the GTK+
                                                                                                toolkit must be installed. For
8.2.11 Interaction with plots ­ latticist and playwith                                          details, go to the website http:
                                                                                                //playwith.googlecode.com/.
Here will be noted the abilities in the latticist and playwith packages,
for interaction with lattice plots.11                                                           11
                                                                                                  More limited abilities are avail-
                                                                                                able to interact with other plots.

latticist(): When called with a data frame as argument, the
function latticist() (in the latticist package) opens a window
that has graphical summary information on the columns of the data
frame. Additionally, it opens a GUI interface to the lattice and vcd
packages, allowing rapid creation of plots that may be useful in their
own right, or may be a first step in creating more carefully crafted
plots. Various annotation features are available from the GUI.


playwith(): This function (from the playwith package) was used
for Figure 8.16. The menu that appears to the left of the graph can
be used to initiate single click identification, to add annotation or                           An alternative is:
arrows, or to mark out a rectangle on the graph for zooming in or                               gph
out. If labels are not specified, row names are used.                                                    x y p l o t ( age  d i s t a n c e ,
    The following code then gives Figure 15.5:                                                                            data=hotspots )
                                                                                                 l i b r a r y ( playwith )
l i b r a r y ( playwith )                                                                       p l a y w i t h ( u p d a t e ( gph ) ,
p l a y w i t h ( x y p l o t ( age  d i s t a n c e , d a t a= h o t s p o t s ) ,                       l a b e l s = h o t s p o t s $name )
                  l a b e l s = h o t s p o t s $name )

    Note that playwith() can be used, also, for more limited inter-
action with plots created using base graphics, or using ggplot2.
116   data analysis, graphics, and visualisation using r


                                                                       Figure 8.16: This playwith GUI
                                                                       window was generated by wrap-
                                                                       ping the call to xyplot() in the
                                                                       function playwith(), then click-
                                                                       ing on Identify. Click near to a
                                                                       point to see its label. A second
                                                                       click adds the label to the graph. A
                                                                       color version appears as 15.5.




8.3     ggplot2 ­ A Grammar of Graphics
                                                                       The ggplot2 syntax is a variant
The ggplot2 syntax is consistent, but less stylized than the lattice   of Wilkinson's "Grammar of
syntax. As with lattice, ggplot2 functions return a graphics object.   Graphics" (Springer, 2nd edn,
The graphics objects that ggplot2 functions return can be saved for    2005).
later use, or updated, or printed directly on to the graphics page.
Each dierent type of ggplot2 graphic display ­ scatterplot, his-
togram, density plot, histogram, etc. ­ is a dierent plot geom, or
"geometry". These can be overlaid.
     The following loads the ggplot2 package:
l i b r a r y ( ggplot2 )



Australian rain data
Figure 8.17 plots annual rainfall for Australia's Murray-Darling
basin region. The following code uses the function quickplot():
l i b r a r y (DAAG)
l i b r a r y ( ggplot2 )
                                                                                                                                                           graphics ­ base, lattice, ggplot, . . .   117

## Default loess smooth , with SE bands added.                                                                                                                       Arguments size (e.g.,
q u i c k p l o t ( Year , mdbRain , d a t a =b o m r e g i o n s 2 0 1 1 ,                                                                                          size=I(2.5)), color (e.g.,
                    geom=c ( " p o i n t " , " smooth " ) , s e =TRUE ,                                                                                              color=I("red"), etc, can be
                    method=" l o e s s " , s p a n =0 . 5 , x l a b =" " ,                                                                                           supplied, aecting both points
                    y l a b =" Av. r a i n f a l l , M D b a s i n " )                                                                                               and the added smooth curve. NB:
                                                                                                                                                                     size=I(2.5), not size=2.5.

                                                                                                                                                                     Figure 8.17: Annual rainfall, from
                           800                                                               
                                                                                                                                                     
                                                                                                                                                                     1901 to 2012, for the Murray-
                                                                                                                                                                     Darling basin region of Australia.
 Av. rainfall, M-D basin




                                                                                                            
                                                                                                               
                                                                                                                                                                     The curve is fitted using the de-
                                                                                                                  
                                                                                                                                                                     fault loess smoother. The point-
                                                  
                           600
                                                                
                                                                                 
                                                                                                                           
                                                                                                                                 
                                                                                                                                             
                                                                                                                                                                     wise standard error bands assume
                                                                                                                                                                     that errors about the curve are
                                                                                                                                              
                                                                                                                                          
                                                                                                                                          
                                                                                    
                                                                                                                                       
                                                                                                                                                                     independent; this is unlikely to
                                                                                                                     
                                          
                                                                   
                                                                                                  
                                                                                                                              
                                                                                                                                                  
                                       
                                                                                                                                                                     be strictly true. To suppress these
                                                                                                                           
                                                           
                                                                          
                                                                                                                                                  
                                                                                 
                                                                                                                                                     
                           400                                               
                                                                                                                     
                                                                                                                                             
                                                                                                                                                                     bands, specify se=FALSE.
                                                                                                                     
                                                                                                            
                                                             
                                                                                                                                       
                                                                                                      
                                                                                                         
                                                                                                                                                  
                                    


                                                 1920                            1950                             1980                           2010




    The function quickplot() (or qplot()) generates a sequence
of function calls that add successive layers to the plot. In order to
allow better control of the details of the plot, those calls can be made
separately, thus:
g g p l o t ( b o m r e g i o n s 2 0 1 2 , a e s ( x=Year , y=mdbRain ) ) +
   geom_point ( ) +
# Scatterplot
   geom_smooth ( s p a n =0 . 5 , s e =TRUE) +                  # Add smooth
   xlab ( " " ) +                               # Blank out x-axis label
   y l a b ( " Av. r a i n f a l l , M D b a s i n " )
## NB: aes () has supplied x- and y-axis variables

     The successive "+" operators combine the separate layers
into a single graphics object. In Figure 8.17, the first layer has the
points, while the second has the smooth curve. Further modifications
change the x- and y-axis labels from the defaults.
     In the call to ggplot(), the data argument is the only manda-
tory argument. It can be repeated in the call(s) to one or more of the
later geom functions. This allows dierent geoms, if required, to take
their data from dierent data frames.
     Changes to color or size or shape settings can be made
separately for each dierent geom. Changing geom_point() to
geom_point(size=2.5) aects only the points.12                                                                                                                        12
                                                                                                                                                                       As the default size for points is
     The function aes() maps variables in the data to visual prop-                                                                                                   2, this increases the size by 25%.
erties ("aesthetics") of geoms. In the code just given, the mappings
are to the x and y axes of the plot. Other possible mappings are
118              data analysis, graphics, and visualisation using r

to color (use color to distinguish groups within the data), shape13                           13
                                                                                                The choice of pch in base
(distinguish by shape), size and fill.                                                        graphics becomes, in ggplot2, a
     A further possibility is to use quickplot() (or qplot()) to                              choice of shape.
create an initial graphics object, then adding to this object. The
following code uses this approach to create Figure 8.17:
q p l o t ( Year , mdbRain , d a t a =b o m r e g i o n s 2 0 1 2 ,
            geom=" p o i n t " ,
            x l a b =" " , y l a b =" Av. r a i n f a l l , M D b a s i n " ) +
   geom_smooth ( s p a n =0 . 5 , s e =TRUE)
    In all cases, a ggplot object is created. This can be printed
immediately, or it can be saved as a named object. The graph is
created using the print method for a ggplot object.
    Try also the following. This requires both the quantreg package
and the splines package:
                                                                                              The normal spline basis ns(x,5)
l i b r a r y ( quantreg )
                                                                                              is supplied to the function that
library ( splines )
                                                                                              estimates the quantile curves,
## Supplementary figure 4
                                                                                              so that 5 d.f. spline curves are
q u i c k p l o t ( Year , mdbRain , d a t a =b o m r e g i o n s 2 0 1 2 ,
                                                                                              fitted at the 20%, 50% and 80%
                    geom=c ( " p o i n t " , " q u a n t i l e " ) ,
                                                                                              quantiles.
                    formula = y  ns ( x , 5 ) ,
                    q u a n t i l e s =c ( 0 . 2 , 0 . 5 , 0 . 8 ) )


Physical measurements of Australian athletes
Figure 8.18 plots height against weight, by sex, for the ais data.
Additionally, boxplots show the distributions of heights, and there
are two-dimensional density contours estimates. The graph is a tad
crowded.

                                                                                              Figure 8.18: Height versus weight,
                                        f                               m                     by sex, for Australian athletes in
                                                                                     

                                                                               
                                                                                              the ais data set. Boxplots that
               200                                                         
                                                                            
                                                                            
                                                                                              show the distributions of heights,
                                                                       
                                                                             
                                                                           
                                                                         
                                                                                              and two-dimensional density
 Height (cm)




                                                                         
                                                                                        
                              
                               
                             
                                                                        
                                                                           
                                                                         
                                                                         
                                                                      
                                                                        
                                                                                              contours have been added.
                                 
               180              
                                                                      
                                                                      
                                                                               
                              
                                
                                                                    
                                                                       
                              
                              
                                 
                                                                     
                                                                       
                              
                                                                     
                            
                                                                   
                                                                    
                                                                
                          
               160      
                             


                                


                           50      75       100     125     50        75       100      125
                                                  Weight (kg)


               The following gives a simplified version of the plot:
## Overlay with boxplots and density contours
q u i c k p l o t ( wt , h t , d a t a = a i s ,
                    geom=c ( " b o x p l o t " , " p o i n t " , " d e n s i t y 2 d " ) ,
                                                                                      graphics ­ base, lattice, ggplot, . . .                               119

                  f a c e t s = .  sex )
    To set axis labels, show the boxplot outline in gray, show con-
tour lines in gray (the default is blue), and make various other
changes as in Figure 8.18, specify:
q u i c k p l o t ( wt , h t , x l a b =" Weight ( kg ) " ,
                    y l a b =" H e i g h t ( cm ) " , d a t a = a i s ,
                    f a c e t s = .  sex ) +
   g e o m _ b o x p l o t ( o u t l i e r . s i z e =1 . 7 5 ,
                              o u t l i e r . c o l o u r =" g r a y " ,
                              c o l o r =" g r a y " ) +
   g e o m _ p o i n t ( s h a p e =2 , s i z e =1) +
   g e o m _ d e n s i t y 2 d ( c o l o r =" g r a y " )
    The facets argument has the form row.var ~ col.var,
where row.var indexes rows of panels, col.var indexes columns,                                           200
and "." serves as a placeholder when there is one row or one column
                                                                                                                                        

                                                                                                                                  
                                                                                                                                               sex
                                                                                                                                  
                                                                                                                                 
                                                                                                         190
only.                                                                                                                                                f
                                                                                                                                                
                                                                                                                                
                                                                                                                                  
                                                                                                                                 
                                                                                                                            
                                                                                                                                
                                                                                                                                                     m
    Code for the next plot will work with a subset of the ais data,
                                                                                                                            
                                                                                                         180                  
                                                                                                                               
                                                                                                                                




                                                                                                    ht
                                                                                                                              
                                                                                                                               
                                                                                                                             
                                                                                                                                               sport
limiting attention to rowers and swimmers:                                                               170
                                                                                                                    
                                                                                                                                                     Row
                                                                                                                                                     Swim
## Extract from ais data for rowers and swimmers                                                         160
                                                                                                               

aisRS        s u b s e t ( a i s , s p o r t %i n% c ( "Row" , " Swim " ) )                                    50      60   70    80   90
                                                                                                                             wt
aisRS $ s p o r t        d r o p l e v e l s ( aisRS $ s p o r t )
    Here are alternative code fragments that can be used to create                                 Figure 8.19: Use color for dis-
                                                                                                   tinguishing sexes, shapes for
Figure 8.19, one using quickplot() and the other using successive
                                                                                                   sports. Figure 15.2 in Appendix
calls to ggplot() and to geom_point():                                                             15 shows the graph in color.

1: Use quickplot():                                      2: ggplot() + geom_point():
q u i c k p l o t ( wt , h t ,                            g g p l o t ( aisRS ) +
                    d a t a =aisRS ,                         g e o m _ p o i n t ( a e s ( wt , h t ,
                    geom=" p o i n t " ,                                               c o l o r =sex ,
                    s i z e =I ( 2 ) ,                                                 shape= s p o r t ) ,
                    c o l o u r =sex ,                                             s i z e =2)
                    shape= s p o r t )
    Multiple aesthetics can be used for the one distinction, here
between sexes:
## Distinguish sex by color & shape
## Different sports have different panels
q u i c k p l o t ( wt , h t , d a t a =aisRS , geom=" p o i n t " ,
                    s i z e = I ( 2 . 5 ) , c o l o r =sex , s h a p e =sex ,
                    facets = .  sport )
     Here are further possibilities:
## Identify sex by color , sport by shape (1 panel)
q u i c k p l o t ( wt , h t , d a t a =aisRS , geom=" p o i n t " ,
                      c o l o r =sex , s h a p e = s p o r t , s i z e = I ( 2 . 5 ) )
## Identify sex by color , sport by size (1 panel )
q u i c k p l o t ( wt , h t , d a t a =aisRS , geom=" p o i n t " ,
                    c o l o r =sex , s i z e = s p o r t )
120    data analysis, graphics, and visualisation using r

Aesthetic mappings vs settings
Note the distinction between settings and aesthetic mappings:

                           Use of quickplot()              Plots based on ggplot()
 Settings                  size=I(3) or cex=3              size=3
 Aesthetic mappings        size=3 or size=sport            aes(size=3) or aes(size=sport)
Use of the argument size=3 in a call to quickplot() does change
the point size, but it adds an extraneous key. The same happens if
the argument mapping=aes(size=3) is supplied to ggplot() or to
geom_point() or to another such function.
    In calls to quickplot(), cex and size are synonyms, as are
color and colour. Also type is a synonym for geom.



Available geometries and settings
Table 8.2 has details of a number of the geometries that are available
for ggplot objects. Table 8.3 lists some of the settings, in addition
to those already noted, that are available:


                                                                               Table 8.2: Available geoms.
      quickplot()          ggplot()                       Available arguments to the geom function
      geom=                                               (data, mapping, color, fill, alpha, plus . . . )
      "point"              +   geom_point()               size, shape, etc.
      "line"               +   geom_line()                size, linetype
      "path"               +   geom_path()1               size, linetype
      "smooth"             +   geom_smooth()              linetype, weight, se (TRUE or FALSE).
      "histogram"          +   geom_histogram()           linetype, weight
      "density"            +   geom_density()             weight, linetype, size
      "density2d"          +   geom_density2d()           weight, linetype, size
a
    Use geom_path() to connect observations, in the original order.




Florence Nightingale's Wedge Plot, and An Alternative                          Florence Nightingale's Crimean
                                                                               War experience prepared her for
Figure 15.3 in Appendix 15 is a "wedge" plot, showing the mortality            later major work in the reform
of British troops according to cause in the Crimean war over 1854­             of army and civilian hospitals
1856. It shows the abilities of the ggplot2 package to spectacular             and public health administration,
                                                                               and to wider social reform. Her
eect. The plot is obtained by using polar coordinates for plotting
                                                                               influence extended to the army and
a stacked bar chart! See also the Figure 15.4 that follows it, which           civilian administration in India.
might be considered as an alternative.
                                                                                           graphics ­ base, lattice, ggplot, . . .   121


                                                                                                     Table 8.3: Additional settings for
                                                                                                     ggplot objects.
                   quickplot()                           ggplot(), . . .
                                                         [eg, + xlab("mylab")]
Title        main="mytitle"                              labs(title="mytitle")
Axis labels xlab="myxlab", etc.                          xlab("myxlab"), etc.2
Facets       facets=sex~sport                            facet_grid(sex~sport)                    c.f., "conditioning"
log axes     see note2                                   scale_x_log()                            log or log10 or log2
Aspect ratio see note3                                   see note4
b
  Alternatively, use scale_x_continuous() or scale_x_discrete()
c
  The function quickplot() returns ggplot objects. Add plot layers just
as for any other ggplot object.
d
  Use coord_equal(). By default (ratio=1), 1cm represents the same
range along both x and y axes.

8.4       Graphics ­ Additional Points
8.4.1       Multiple graphs on a single graphics page
For base graphics, refer back to Subsection 8.1.6. The following
demonstrates use of the fig argument to par() to select a part of
the display region for plotting:
par ( f i g = c ( 0 , 1 , 0 .38 , 1 ) )
                # xleft , xright , ylow , yhigh
## Plot graph A
p a r ( f i g = c ( 0 , 1 , 0 , 0 . 3 8 ) , new=TRUE)
## Plot graph B
par ( f i g = c (0 , 1 , 0 , 1))             # Resets to default
    For lattice graphs, the location of the graph can be determined
by the argument position, when print() is called. The following
demonstrates its use:
cuckoos.strip                      s t r i p p l o t ( species  length ,
                                                       x l a b =" " , d a t a =c u c k o o s )
p r i n t ( c u c k o o s . s t r i p , p o s i t i o n =c ( 0 , 0 . 5 , 1 , 1 ) )
                                       # xleft , ybottom , xright , ytop
cuckoos.bw                   b w p l o t ( s p e c i e s  l e n g t h , x l a b =" " ,
                                           d a t a =c u c k o o s )
p r i n t ( c u c k o o s . b w , p o s i t i o n =c ( 0 , 0 , 1 , 0 . 5 ) ,
            newpage=FALSE )
     Note the use of newpage=FALSE for the second plot.

Base and trellis plots on the same graphics page
The following uses the base graphics command mtext() to label a
lattice plot:
p l o t ( 0 : 1 , 0 : 1 , t y p e =" n " , b t y =" n " , a x e s =FALSE ,
          x l a b =" " , y l a b =" " )
 122    data analysis, graphics, and visualisation using r

 lab           " L a t t i c e bwplot ( i . e . , boxplot ) "
 m t e x t ( s i d e =3 , l i n e =3 , l a b )
 cuckoos.bw                   b w p l o t ( s p e c i e s  l e n g t h , d a t a =c u c k o o s )
 p r i n t ( c u c k o o s . b w , newpage=FALSE )


 Inclusion of graphs in Microsoft Word
 Graphs may not import well from the clipboard into Word on the
 Macintosh under OS X. On Windows systems, an eective option
 is to use win.metafile() to write graphics output to a Windows
 metafile format that should import without problem into a Word or
 Power Point document.


 8.5       Summary
   Base graphics functions plot a graph. Lattice anf ggplot2 functions
   return a graphics object. which can then stored or updated or
   plotted (printed).

   A powerful feature, both of ggplot2 graphics and of lattice graph-
   ics when the layering abilities of the latticeExtra package is used,
   is the ability to build a graph up layer by layer.

   The R system makes available, via its various package, a wide
   variety of other graphics abilities. This includes dynamic and
   other 3-dimensional graphics.


 8.6       Exercises
 In the following exercises, if there is no indication of whether to use
 base or lattice graphics, use whichever seems most suitable.

1. Exercise 1 in Section 4.4.2 showed how to create the data frame
   molclock. Plot AvRate against Myr. Use abbreviate() to
   create abbreviated versions of the row names, and use these to
   label the points.

2. Compare the following graphs that show the distribution of head
   lengths (hdlngth) in the possum data set. What are the advan-
   tages and disadvantages of these dierent forms of display?

       a) a histogram (hist(possum$hdlngth));
       b) a stem and leaf plot (stem(qqnorm(possum$hdlngth));
       c) a normal probability plot (qqnorm(possum$hdlngth)); and
       d) a density plot (plot(density(possum$hdlngth)).
                                                                    graphics ­ base, lattice, ggplot, . . .   123

3. This exercise uses the data set hotspots (DAAG package).
   Plot age against distance. Use identify() to determine which
   years correspond to the two highest mean levels. That is, type
    p l o t ( age  d i s t a n c e , d a t a= h o t s p o t s )
    with ( h o t s p o t s , i d e n t i f y ( age 
    d i s t a n c e , l a b e l s =name ) )

   Use the left mouse button to click on the highest two points on the
   plot. (Right click in the figure region to terminate labeling.)

4. Use mfrow() to set up the layout for a 3 by 4 array of plots. In
   the top 4 rows, show normal probability plots for four separate
   `random' samples of size 10, all from a normal distribution. In the
   middle 4 rows, display plots for samples of size 100. In the bot-
   tom four rows, display plots for samples of size 1000. Comment
   on how the appearance of the plots changes as the sample size
   changes.

5. The function runif() can be used to generate a sample from a
   uniform distribution, by default on the interval 0 to 1. Print out the
   numbers you get from x <- runif(10). Then repeat exercise 6
   above, but taking samples from a uniform distribution rather than
   from a normal distribution. What shape do the points follow?

6. The data frame airquality that is in the base package has
   columns Ozone, Solar.R, Wind, Temp, Month and Day. Plot
   Ozone against Solar.R for each of three temperature ranges, and
   each of three wind ranges.
124   data analysis, graphics, and visualisation using r
9
Dynamic Interaction with Graphs

This chapter will describe a range of abilities that create displays
which the user can then manipulate dynamically. Note in particular
the googleVis package, designed for interactive exploration of dy-
namic changes in relationships with time. It reproduces most of the
abilities of Google's Public Data Explorer, which can be accessed at
http://www.google.com/publicdata/home


9.1    Dynamic Graphics ­ rgl and rggobi
Both these packages provide three-dimensional dynamic graphics.
The following uses the functions scatter3d() and identify3d()
from the Rcmdr package. These may be more convenient for novices
than the rgl functions that they call:
## The Rcmdr and rgl packages must be installed
library(DAAG)
library(Rcmdr) # Makes scatter3d() available
open3d() # Precedes the call to par3d()
par3d(cex=0.75) # Optional
                 # Other params: see help(par3d)
with(nihills, scatter3d(x=log(dist), y=log(climb),
                     z=log(time),
                     grid=FALSE,
                     surface.col="gray",
                     point.col="black",
                     axis.scales=FALSE))
with(nihills, identify3d(x=log(dist), y=log(climb),
                      z=log(time),
                      labels=row.names(nihills),
                      col="gray40"))
## NB: Use middle or right mouse button to drag a
## rectangle around a point that is to be labeled.

Following the call to identify3d(), use the middle (or maybe             Use rgl.snapshot() to save the
right) mouse button to drag a rectangle around any point that is to be   current plot into a file.
labeled. To cease identifying points, make a middle (or right) click
126   data analysis, graphics, and visualisation using r

on an empty region of the plot.
     Such a plot can be helpful in identifying high leverage
points, e.g., in the regression of log(time) on log(dist) and
log(climb). The plot needs to be rotated to give a view in which
the leverage is apparent.
     The rggobi package oers a wider range of features, via
an interface to the GGobi system. For installation details go to
http://www.ggobi.org/. Windows users can use the follow-
ing to install all the required files from an R session that has access
to a live internet connection:
source("http://www.ggobi.org/downloads/install.r")



9.2     The googleVis Package
This provides an interface to the abilities of Google's Public Data
Explorer. While these abilities can be accessed from the web page
noted below, there are obvious advantages in setting up the display
from one's own computer.1                                                 1
                                                                            When plotting from a user's
                                                                          computer, an internet connection
                                                                          is needed to access Google's API
9.2.1    Google's Public Data Explorer                                    (Application Program Interface)
Upon accessing Google's web page http://www.google.com/                   when the chart is displayed.
publicdata/home, the display will cycle through examples
of the use of Motion Charts, and other related charts. Click on
Explore Data to go to the interactive version of the relevant dis-
play.2 These charts, which are interesting in themselves, show the        2
                                                                           Various controls are placed in
abilities that googleVis is designed to emulate. See the annotations in   the margins of the graph. Move
Figure 9.1 below for details that should be enough to get started.        the pointer over one or other
                                                                          control feature to get information
     A slider below the graph can be moved to show how the re-
                                                                          on its purpose, or over a point to
lationships that are plotted change over the available timespan,          display information about that
commonly 1960 through to 2010 (but note that not all data will            point. For changing the x- and/or
be available for all years). Click on the solid right-pointing triangle   y- variables, or for changing the
on the left of the slider scale to see the graph changing dynamically     variable that determines point size,
in moving from the currently shown year through to 2010.                  click on the relevant downward
                                                                          pointing selector arrow. Scales,
                                                                          separately for the two axes, can be
9.2.2    Use of googleVis to create motion charts                         either linear or logarithmic.

The details given here should be supplemented with examination
of the vignette that accompanies the googleVis package. Note espe-        To display the vignette, type:
cially Figure 1 on page 5 of the vignette.                                vignette("googleVis")
     Creation of a motion chart, once the data is in place, is remark-
ably straightforward. The starting point is a data frame in that has
a column (e.g. Countries) that can be used as an id variable, a col-
umn (e.g. Year) that has a timevar variable, and columns that can
                                                                     dynamic interaction with graphs       127

be used to supply x- and y- variables. Optionally, columns may be
identified for use as a colorvar and/or a sizevar.
    The dataset grog from the DAAG package has a suitable struc-
ture. One can create a motion chart thus:
library(googleVis)
M <- gvisMotionChart(grog, id="Country", timevar="Year")
## This next line requires a live internet connection,
## and Adobe Flash must be installed.
plot(M)

A browser window with a gray display region should appear. To
proceed, click on gray letters in the middle of the screen that say
'Flash'.
     For the grog dataset, the Motion Chart does a less satisfactory
job than Figure 8.10 in Section 8.2.4. Motion charts come into their
own for the examination of steady changes over time in a bivari-
ate relationship, with dierent patterns of relationship for dierent
subgroups of the data.
     A plot that allows the display of various World Bank develop-
ment indicators can be obtained by typing:                                 The code used to download the
                                                                           data and display the motion chart
demo(WorldBank)
                                                                           will appear on your screen.
This can take a while to start up ­ data has to be downloaded from
the World Bank web site. If the browser window that appears dis-
plays gray letters in the middle of the screen that say 'Flash', click
there to proceed. Hover the mouse pointer over features that appear
in the margins of the display to see annotation that indicates how
you can change or manipulate various aspects of the display.
     The data from the World Bank site is stored into a data frame
WorldBank. The command that creates a gvis object M is:3                   3
                                                                             Both WorldBank and M should
M <- gvisMotionChart(WorldBank, idvar="country",                           be in your workspace after run-
         timevar="year",                                                   ning demo(WorldBank). To
         xvar="life.expectancy", yvar="fertility.rate",                    obtain the data without running
         colorvar="region", sizevar="population",                          the demonstration, load the image
         options=list(width=700, height=600))                              file WorldBank.RData that is
## Now display the motion chart                                            available from the url noted on the
plot(M)                                                                    reverse of the title page.

Change width and height as needed to make better use of the
screen display.
    If arguments are supplied, security setting issues on the user
computer can result in an initial assignment of columns that does not
accord with the supplied arguments.4 The drop-down menus should            4
                                                                             In the creation of the gvis ob-
however function correctly, and can be used to obtain a display that       ject M, Javascript code is gen-
accords with any choice of arguments that the user may want.               erated that can be included on a
    For a further example, load the image file wdiSel.RData, avail-        web page. This should display
                                                                           correctly when the web page is
able from the url noted on the reverse of the title page. This will        accessed.
128   data analysis, graphics, and visualisation using r

make available the data frame wdiSel. This has a larger number of
indicators, but for 26 countries only. Figure 9.1 shows an annotated
version of a motion chart that was created from this dataset.




                                                                       Figure 9.1: Snapshot of a motion
                                                                       chart, with annotation overlaid
                                                                       that draws attention to a selected
    The following code generated the initial chart. The change to a    chart features that can be modified
log scale on the vertical axis was made interactively:                 interactively. For a color version,
                                                                       see Figure 9.1.
xnam <- "Electric power consumption (kWh per capita)"
ynam <- "Mobile cellular subscriptions (per 100 people)"
M <- gvisMotionChart(wdiSel, idvar="Country.Name",
                  timevar="Year", xvar=xnam, yvar=ynam,
                  colorvar="region",
                  sizevar="Population, total",
                  options=list(width=600, height=500),
                  chartid="wbMotionChartSel")
plot(M)
